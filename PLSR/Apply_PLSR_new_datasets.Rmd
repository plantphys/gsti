---
title: "Applying PLSR models to new data"
author: "Julien Lamour"
date: "2025-10-15"
output: md_document
---

## Overview and important note

This tutorial shows how to apply pre-trained Partial Least Squares Regression (PLSR) models developped using the GSTI project to predict photosynthetic traits from leaf reflectance spectra. The models for `Vcmax25`, `Jmax25`, `TPU25`, and `Rdark25` are available here:

[https://github.com/plantphys/gsti/tree/main/PLSR](https://github.com/plantphys/gsti/tree/main/PLSR)

Each file with the `.Rdata` extension contains a PLSR model for a specific trait.

The PLSR models provided here were built as described in the GSTI paper primarily for illustrative purposes. They were calibrated using all available datasets that included full-range spectra (400-2500 nm), without strategic selection for balanced biome or species coverage.

This approach and data coverage introduced important limitations:


- *Biome Gaps:* Certain biomes are underrepresented or missing from the training data.
- *Species Bias:* The dataset contains a much larger proportion of crop species compared to wild species.

As discussed in the original paper, these factors may limit the model's accuracy and generalizability when applied to data from underrepresented biomes or wild species not seen during training.

For specific applications, we strongly recommend considering a re-calibration of the model using a training dataset that is carefully selected for your target biome, species, or functional types. This can be done by adapting the scripts located in the folder PLSR for each variable (e.g for Vcmax25: [PLSR_models_Vcmax25](https://github.com/plantphys/gsti/blob/main/PLSR/PLSR_models_Vcmax25.R)).

The provided models serve as a robust starting point and a demonstration of the method, but can likely be improved with more targeted calibration.

## 1. Load required libraries

```{r message=FALSE, warning=FALSE}
library(here)  ## Used to identify the project repository
library(pls) ## Used to build and use the plsr models
```
## 2. Load the PLSR models

For this example, we will load the `Vcmax25` PLSR model. The package "here" helps to correcly set the working directory to the project repository.

```{r}
path = here() ## Identify project repository
setwd(file.path(path,'/PLSR'))
load(file = "PLSR_model_Vcmax25.Rdata", verbose = TRUE) 
```
Loading the .Rdata file adds three objects to your environment:

- plsr_model: The actual PLSR model for Vcmax25.

- training: The subset of the GSTI database used to calibrate the model.

- validation: An independent subset (20% of data) used to validate the model.



The plsr_model object is a list with several components. Key components for prediction are:

- ncomp: The number of latent components used in the model.

- coefs: A matrix containing 1000 sets of coefficients from the 1000 bootstrapped PLSR models. Row 1 corresponds to the intercepts for the 1000 models and rows 2-2102 correspond to the coefficients associated with the reflectance wavelengths from 400 to 2500 nm.

Let's visualize the distribution of coefficients across the 1000 models.

```{r}

intercepts <- plsr_model$coefs[1,]
coefs <- plsr_model$coefs[2:2102,]  ## We only use the 2:2102 lines to exclude the intercept from the calculations
mean_spec <- rowMeans(coefs) ## Mean of the coefficients.  
coef_quantiles <- apply(coefs,1,quantile,na.rm=T,probs=c(0,0.01,0.025,0.05,0.5,0.95,0.975,0.99,1))

wv <- 400:2500 ## Wavelengths of the PLSR model

plot(x=NULL,y=NULL,xlim=c(400,2500),ylim=c(min(coefs),max(coefs)),xlab="Wavelength (nm)",
     ylab="Coefficient",main="Coefficients of the PLSR model")
polygon(c(wv ,rev(wv)),c(coef_quantiles[9,], rev(coef_quantiles[1,])),
        col="grey60",border=NA)
polygon(c(wv ,rev(wv)),c(coef_quantiles[6,], rev(coef_quantiles[4,])),
        col="#99CC99",border=NA)
lines(wv,mean_spec,lwd=2, lty=1, col="black")
lines(wv,coef_quantiles[1,], lty=3, col="grey60")
lines(wv,coef_quantiles[9,], lty=3, col="grey60")
legend("top",legend=c("Mean coefficients","Min/Max (range)", "95% CI"),lty=c(1,1,1),
       lwd=c(2,10,10),col=c("black","grey50","#99CC99"),bty="n")
box(lwd=2.2)

```


### 3. Importing and preparing reflectance data

In this example, we will predict Vcmax25 for the leaf reflectance spectra in the validation dataset. You can replace this with your own data.

If you use your own data, the reflectance matrix must meet the following criteria:

 - Reflectance values are in percent (0-100).

 - Each row represents a different leaf sample.

 - Each column represents a wavelength from 400 to 2500 nm at a 1 nm interval (2102 bands total).


Let's first visualize the reflectance data we are using.

```{r}
Reflectance <- unclass(validation$Spectra)

mean_spec <- colMeans(Reflectance) ## Mean of the coefficients.  
coef_quantiles <- apply(Reflectance,2,quantile,na.rm=T,probs=c(0,0.01,0.025,0.05,0.5,0.95,0.975,0.99,1))

wv <- 400:2500 ## Wavelengths of the PLSR model

plot(x=NULL,y=NULL,xlim=c(400,2500),ylim=c(min(Reflectance),max(Reflectance)),xlab="Wavelength (nm)",
     ylab="Coefficient",main="Reflectance")
polygon(c(wv ,rev(wv)),c(coef_quantiles[9,], rev(coef_quantiles[1,])),
        col="grey60",border=NA)
polygon(c(wv ,rev(wv)),c(coef_quantiles[6,], rev(coef_quantiles[4,])),
        col="#99CC99",border=NA)
lines(wv,mean_spec,lwd=2, lty=1, col="black")
lines(wv,coef_quantiles[1,], lty=3, col="grey60")
lines(wv,coef_quantiles[9,], lty=3, col="grey60")
legend("topright",legend=c("Mean reflectance","Min/Max (range)", "95% CI"),lty=c(1,1,1),
       lwd=c(2,10,10),col=c("black","grey50","#99CC99"),bty="n")
box(lwd=2.2)
```

## 4. Prediction of Vcmax25 and calculation of uncertainties

We calculate the PLSR model prediction by multiplying the reflectance matrix by the coefficients and adding the intercepts. Because we have 1000 models, we get 1000 predictions, which allows us to compute confidence intervals.

Crucial Note: The PLSR model was built using a square-root transformation of Vcmax25 to normalize its distribution. We must back-transform the predictions by squaring them.

```{r fig.dim= c(6,6)}
prediction <- intercepts + Reflectance%*%coefs ## prediction = intercept + coef_400nm * wavelength_400nm + coef_401nm * wavelength_401nm + ... + coef_2500nm * wavelength_2500 nm, or in matrix notation Prediction = intercept + Coefs * Reflectancte 
Vcmax25 <-  prediction^2 ## Vcmax25 was square root transformed to build the plsr model, and needs to be transformed back 
Mean_Vcmax25 <- rowMeans(Vcmax25) ## Average Vcma25 predicted by the 1000 PLSR models
lower_ci <- apply(X = Vcmax25, MARGIN = 1, FUN = quantile, probs = 0.025) ## Lower confidence interval (2.5 %)
upper_ci <- apply(X = Vcmax25, MARGIN = 1, FUN = quantile, probs = 0.975) ## Upper confidence interval (97.5 %)

plot(x = validation$Vcmax25, y = Mean_Vcmax25, xlab = "Observed Vcmax25", ylab = "PLSR prediction", pch = 16, xlim = c(0, max(Mean_Vcmax25,validation$Vcmax25)), ylim = c(0, max(Mean_Vcmax25,validation$Vcmax25)), cex = 0.5)

arrows(x0 = validation$Vcmax25, 
       y0 = lower_ci, 
       y1 = upper_ci, 
       angle = 90, 
       code = 3, 
       length = 0.01,
       col = "grey") ## Adding the confidence interval

## Adding back the points so they are not overplot by the con
points(x = validation$Vcmax25, y = Mean_Vcmax25, pch = 16, cex = 0.5)

abline(c(0,1))
```




